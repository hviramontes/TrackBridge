<Window x:Class="TrackBridge.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:TrackBridge"
        Title="TrackBridge"
        Height="650"
        Width="900"
        WindowStartupLocation="CenterScreen"
        Loaded="Window_Loaded"
        Closing="Window_Closing">
    <Window.Resources>
        <!-- Dim stale rows older than 30 seconds -->
        <local:StaleOpacityConverter x:Key="StaleOpacityConverter" ThresholdSeconds="30"/>
        <local:AgeToBrushConverter x:Key="AgeToBrushConverter"/>
    </Window.Resources>

    <DockPanel>

        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="Save _CSV"      Click="SaveToCsv_Click"/>
                <MenuItem Header="Preview _CoT"   Click="PreviewCot_Click"/>
                <MenuItem Header="Import _Stubs…" Click="ImportStubs_Click"/>
                <Separator/>
                <MenuItem Header="E_xit"          Click="Close_Click"/>
            </MenuItem>

            <MenuItem Header="_Filters">
                <MenuItem Header="_Load Filters"         Click="LoadFilters_Click"/>
                <MenuItem Header="_Save Filters"         Click="SaveFilters_Click"/>
                <Separator/>
                <MenuItem Header="Load Filter _Profile…" Click="LoadProfile_Click"/>
                <MenuItem Header="Save Filter _Profile"  Click="SaveProfile_Click"/>
                <MenuItem Header="_Delete Profile"       Click="DeleteProfile_Click"/>
            </MenuItem>

            <MenuItem Header="_Map">
                <MenuItem Header="_Load Map"        Click="OpenMapPreview_Click"/>
                <MenuItem Header="_Download Tiles"  Click="OpenDownloadArea_Click"/>
                <MenuItem Header="_Import MBTiles"  Click="ImportMbtiles_Click"/>
            </MenuItem>

            <MenuItem Header="_Settings">
                <MenuItem Header="_Network Settings" Click="OpenNetworkSettings_Click"/>
            </MenuItem>

            <MenuItem Header="_Logs">
                <MenuItem Header="_Open Logs Folder"    Click="OpenLogsFolder_Click"/>
                <MenuItem Header="_Load Log for Replay" Click="LoadLogForReplay_Click"/>
            </MenuItem>
        </Menu>

        <!-- Network & Search Panel -->
        <!-- Network & Search Panel -->
        <DockPanel DockPanel.Dock="Top" Margin="5" LastChildFill="True">
            <!-- Left: DIS IP & Port -->
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center" Margin="0,0,10,0">
                <TextBlock Text="DIS IP:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <ComboBox x:Name="DisIpComboBox"
                  Width="180"
                  Margin="0,0,10,0"/>
                <TextBlock Text="Port:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <TextBox x:Name="DisPortTextBox"
                 Width="60"
                 Margin="0,0,5,0"/>
                <Button Content="Apply"
                x:Name="ApplyDisButton"
                Click="ApplySettings_Click"
                Width="75"
                Margin="0,0,0,0"
                VerticalAlignment="Center"/>
            </StackPanel>

            <!-- Center: Search -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBox x:Name="SearchTextBox"
                 Width="150"
                 ToolTip="Enter entity ID or marking"
                 Margin="0,0,5,0"/>
                <Button Content="Search"
                Click="Search_Click"
                MinWidth="75"/>
            </StackPanel>

            <!-- Right: CoT IP & Port -->
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center" Margin="10,0,0,0">
                <TextBlock Text="CoT IP:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <TextBox x:Name="CotIpTextBox"
                 Width="120"
                 Margin="0,0,10,0"/>
                <TextBlock Text="Port:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <TextBox x:Name="CotPortTextBox"
         Width="60"
         LostFocus="CotPortTextBox_LostFocus"/>
                <Button Content="Apply"
        x:Name="ApplyCotButton"
        Click="ApplyCotSettings_Click"
        Width="60"
        Margin="10,0,0,0"
        VerticalAlignment="Center"/>
                <TextBlock Text="Heartbeat (sec):"
           Margin="15,0,5,0"
           VerticalAlignment="Center"/>
                <TextBox x:Name="HeartbeatIntervalTextBox"
         Width="50"
         VerticalAlignment="Center"
         ToolTip="Seconds between CoT pings"/>
                <Button Content="Apply"
        Click="ApplyHeartbeat_Click"
        Width="60"
        Margin="5,0,0,0"
        VerticalAlignment="Center"/>

            </StackPanel>
        </DockPanel>


        <!-- Playback controls + Test Track button -->
        <!-- Playback controls + Test Track + Open Map buttons -->
        <DockPanel DockPanel.Dock="Bottom" Margin="5" LastChildFill="False">
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center">
                <Button Content="Play"
            Click="PlayReplay_Click"
            Margin="0,0,5,0"
            MinWidth="75"/>
                <Button Content="Pause"
            Click="PauseReplay_Click"
            Margin="0,0,5,0"
            MinWidth="75"/>
                <Button Content="Stop"
            Click="StopReplay_Click"
            MinWidth="75"
            Margin="0,0,10,0"/>
                <TextBlock Text="Replay Speed:"
               VerticalAlignment="Center"
               Margin="5,0,5,0"/>
                <ComboBox x:Name="ReplaySpeedComboBox"
              Width="80"
              SelectedIndex="1"
              VerticalAlignment="Center">
                    <ComboBoxItem Content="0.5x"/>
                    <ComboBoxItem Content="1x"/>
                    <ComboBoxItem Content="2x"/>
                    <ComboBoxItem Content="5x"/>
                </ComboBox>
            </StackPanel>


            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,0,0">
                <Button Content="Test Track"
                Click="TestTrack_Click"
                MinWidth="80"
                Padding="5,2"
                Margin="0,0,5,0"/>
                <Button Content="Open Map"
                Click="OpenMapPreview_Click"
                MinWidth="80"
                Padding="5,2"/>
            </StackPanel>
        </DockPanel>


        <!-- TAK Connectivity Indicator -->
        <StatusBar DockPanel.Dock="Bottom" VerticalAlignment="Bottom">
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Ellipse x:Name="DisIndicator"
                     Width="12" Height="12"
                     Stroke="Black" StrokeThickness="1"
                     Fill="Gray"
                     Margin="0,0,5,0"/>
                    <TextBlock Text="DIS"
                       VerticalAlignment="Center"
                       Margin="0,0,10,0"/>
                    <Ellipse x:Name="TakIndicator"
                     Width="12" Height="12"
                     Stroke="Black" StrokeThickness="1"
                     Fill="Gray"
                     Margin="0,0,5,0"/>
                    <TextBlock Text="TAK"
                       VerticalAlignment="Center"
                       Margin="0,0,10,0"/>
                    <TextBlock x:Name="LastPingText"
                       Text="Last Ping: --:--:--"
                       VerticalAlignment="Center"/>
                    <TextBlock x:Name="ErrorText"
                         Text=""
                         Foreground="Red"
                         VerticalAlignment="Center"
                         ToolTip="Most recent send error"/>
                    <TextBlock x:Name="TrackCountText"
                           Text="Total: 0"
                           Margin="10,0,0,0"
                           VerticalAlignment="Center"/>
                    <TextBlock x:Name="ReplaySpeedText"
                           Text="Speed: 1x"
                           Margin="10,0,0,0"
                           VerticalAlignment="Center"/>
                    <TextBlock x:Name="ReplayStatusText"
                           Text="Replay: ⏹️ Stopped"
                           Margin="10,0,0,0"
                           VerticalAlignment="Center"/>

                </StackPanel>
            </StatusBarItem>
        </StatusBar>

        <!-- Replay Progress Row -->
        <StackPanel Orientation="Horizontal" Margin="10,0,0,5" Visibility="Collapsed" x:Name="ReplayProgressPanel">
            <TextBlock Text="Replay Progress:" Foreground="White" VerticalAlignment="Center"/>
            <ProgressBar x:Name="ReplayProgressBar" Width="300" Height="15" Margin="10,0"/>
            <TextBlock x:Name="ReplayTimestampText" Foreground="LightGray" VerticalAlignment="Center" Margin="10,0"/>
        </StackPanel>

        <!-- Log output -->
        <TextBox x:Name="LogOutput"
                 DockPanel.Dock="Bottom"
                 Height="100"
                 Margin="5"
                 FontSize="12"
                 IsReadOnly="True"
                 VerticalScrollBarVisibility="Auto"
                 TextWrapping="Wrap"/>

        <!-- Entity Grid -->
        <DataGrid x:Name="EntityGrid"
    AlternationCount="2"
    AlternatingRowBackground="LightGray"
    AutoGenerateColumns="False"
    EnableRowVirtualization="True"
    VirtualizingPanel.VirtualizationMode="Recycling"
    CanUserAddRows="False"
    IsReadOnly="True"
    CanUserSortColumns="True"
    CanUserResizeColumns="True"
    Margin="5"
    MouseDoubleClick="EntityGrid_MouseDoubleClick">
            <DataGrid.RowStyle>
                <Style TargetType="DataGridRow">
                    <Setter Property="Opacity"
                            Value="{Binding Timestamp, Converter={StaticResource StaleOpacityConverter}}"/>
                    <!-- NEW: background color based on age -->
                    <Setter Property="Background"
            Value="{Binding Timestamp, Converter={StaticResource AgeToBrushConverter}}"/>
                </Style>
            </DataGrid.RowStyle>
            <DataGrid.Columns>
                <DataGridTextColumn Header="ID"      Binding="{Binding Id}" Width="Auto"/>
                <DataGridTextColumn Header="Marking" Binding="{Binding CustomMarking}" Width="*"/>
                <DataGridTextColumn Header="MGRS"    Binding="{Binding Mgrs}" Width="*"/>
                <DataGridTextColumn Header="Alt"     Binding="{Binding Altitude}" Width="Auto"/>
                <DataGridTextColumn Header="Time"    Binding="{Binding Timestamp, StringFormat=HH:mm:ss}" Width="Auto"/>
                <DataGridTextColumn Header="Country" Binding="{Binding CountryCode}" Width="Auto"/>
                <DataGridTextColumn Header="Icon"    Binding="{Binding IconType}" Width="Auto"/>
                <DataGridCheckBoxColumn Header="🔒 Locked"
                             Binding="{Binding IsCustomMarkingLocked}"
                             IsReadOnly="True"
                             Width="Auto" />
            </DataGrid.Columns>
        </DataGrid>
    </DockPanel>
</Window>
